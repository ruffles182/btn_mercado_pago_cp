<!-- SDK MercadoPago.js -->
<script src="https://sdk.mercadopago.com/js/v2"></script>

<!-- Contenedor para el botÃ³n de pago -->
<div id="wallet_container"></div>

<script>
async function getShopifyCart() {
    const response = await fetch('/cart.js');
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    const cart = await response.json();
    return cart;
}

async function sendCartToServer(cart) {
    try {
        const simplifiedCart = {
            items: cart.items.map(item => ({
                title: item.title,
                quantity: item.quantity,
                price: item.price
            }))
        };

        // Log del JSON antes de enviarlo
        console.log("JSON a enviar:", JSON.stringify(simplifiedCart, null, 2));

        const response = await fetch('https://rentaeventos.com.mx/pcreate.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(simplifiedCart)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log("Respuesta del servidor:", data);
        return data.preference_id;
    } catch (error) {
        console.error('Error enviando el carrito al servidor:', error);
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    try {
        const cart = await getShopifyCart();
        const preferenceId = await sendCartToServer(cart);
        if (preferenceId) {
            const mp = new MercadoPago('APP_USR-192113d9-4900-489e-82f1-d6328395d064');
            const bricksBuilder = mp.bricks();
          
            mp.bricks().create("wallet", "wallet_container", {
               initialization: {
                   preferenceId: preferenceId,
               },
            customization: {
             texts: {
              valueProp: 'smart_option',
             },
             },
            });
        }
    } catch (error) {
        console.error('Error:', error);
    }
});
</script>